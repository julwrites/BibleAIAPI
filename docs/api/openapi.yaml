openapi: 3.0.0
info:
  title: Bible API Service
  version: 1.0.0
  description: An API for querying and interacting with Bible verses.
servers:
  - url: http://localhost:8080
    description: Local development server
paths:
  /bible-versions:
    get:
      summary: List available Bible versions
      description: Retrieve a list of available Bible versions with filtering, sorting, and pagination.
      security:
        - ApiKeyAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: Page number for pagination.
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          description: Number of items per page.
        - in: query
          name: name
          schema:
            type: string
          description: Filter versions by name (case-insensitive partial match).
        - in: query
          name: language
          schema:
            type: string
          description: Filter versions by language (case-insensitive partial match).
        - in: query
          name: sort
          schema:
            type: string
            enum: [code, name, language]
            default: code
          description: Field to sort by.
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /query:
    post:
      summary: Submit a query
      description: >-
        Submits a query to the Bible API service. The query must contain exactly one of: `verses`, `words`, or `prompt`.

        - **Prompt**: If `query.prompt` is present, the service processes the prompt using the LLM. Context can be provided in the `context` object.
        - **Verse Query**: If `query.verses` is present, the service retrieves the specified verses.
        - **Word Search**: If `query.words` is present, the service searches for the words in the Bible.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/VerseResponse'
                  - $ref: '#/components/schemas/WordSearchResponse'
                  - $ref: '#/components/schemas/PromptResponse'
                  - type: object
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-KEY

  schemas:
    QueryRequest:
      type: object
      properties:
        query:
          type: object
          properties:
            verses:
              type: array
              items:
                type: string
                example: "John 1:12"
              description: "List of Bible verse references to retrieve."
            words:
              type: array
              items:
                type: string
                example: "Grace"
              description: "List of words to search for in the Bible."
            prompt:
              type: string
              example: "How many people did Jesus feed?"
              description: "A prompt for the LLM chat interface."
        context:
          type: object
          description: "Context for the query. Only valid if query.prompt is present."
          properties:
            history:
              type: array
              items:
                type: string
              description: "Chat history or previous queries."
            schema:
              type: string
              description: "A JSON schema to structure the LLM response."
            verses:
              type: array
              items:
                type: string
            words:
              type: array
              items:
                type: string
              description: "List of words to search for and include as context."
            user:
              type: object
              properties:
                version:
                  type: string
                  example: "ESV"

    VersionsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Version'
        total:
          type: integer
          example: 233
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 20

    Version:
      type: object
      properties:
        name:
          type: string
          example: "New International Version (NIV)"
        value:
          type: string
          example: "NIV"
        language:
          type: string
          example: "English (EN)"

    PromptResponse:
      type: object
      properties:
        data:
          type: object
          description: "The structured response data (schema depends on the request schema, defaults to OQueryResponse)."
        meta:
          type: object
          description: "Metadata about the response."
          properties:
            ai_provider:
              type: string
              example: "openai"

    VerseResponse:
      type: object
      properties:
        verse:
          type: string
          example: "John 3:16 (ESV) For God so loved the world, that he gave his only Son, that whoever believes in him should not perish but have eternal life."

    WordSearchResponse:
      type: array
      items:
        type: object
        properties:
          verse:
            type: string
            example: "Romans 3:24"
          text:
            type: string
            example: "For all have sinned and fall short of the glory of God"
          url:
            type: string
            example: "https://classic.biblegateway.com/passage/?search=Romans+3%3A24&version=ESV"

    OQueryResponse:
      type: object
      properties:
        text:
          type: string
          example: "Jesus fed 5,000 men, not including women and children."
        references:
          type: array
          items:
            type: object
            properties:
              verse:
                type: string
                example: "Matthew 14:21"
              url:
                type: string
                example: "https://classic.biblegateway.com/passage/?search=Matthew+14%3A21&version=ESV"

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: integer
              example: 401
            message:
              type: string
              example: "Invalid API Key"
